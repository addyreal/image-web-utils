const main=document.getElementById("main"),_input=document.getElementById("input_label"),preview_container=document.getElementById("preview_container"),_c_image_view=document.getElementById("_c_image_view"),_c_image_hide=document.getElementById("_c_image_hide"),config_popup=document.getElementById("config_popup"),_c_config_view=document.getElementById("_c_config_view"),_c_config_hide=document.getElementById("_c_config_hide"),_c_convert_encode=document.getElementById("_c_convert_encode"),config_container=document.getElementById("config_container"),canvas_container=document.getElementById("canvas_container"),config_format=document.getElementById("config_format"),config_quality=document.getElementById("config_quality"),config_quality_visual=document.getElementById("config_quality_visual"),config_width=document.getElementById("config_width"),config_width_auto=document.getElementById("config_width_auto"),config_height=document.getElementById("config_height"),config_height_auto=document.getElementById("config_height_auto"),download_div=document.getElementById("download_div");var previewWindow={scale:1,lastTouchesDist:0,lastX:0,lastY:0,offsetX:0,offsetY:0,isDragging:!1,isTouchZooming:!1};function resetPreviewWindow(){previewWindow={scale:1,lastTouchesDist:0,lastX:0,lastY:0,offsetX:0,offsetY:0,isDragging:!1,isTouchZooming:!1}}const canvas=document.getElementById("canvas"),context=canvas.getContext("2d");context.imageSmoothingEnabled=!1;const vCanvas=document.createElement("canvas"),vContext=vCanvas.getContext("2d");function draw(){context.setTransform(1,0,0,1,0,0),context.clearRect(0,0,canvas.width,canvas.height),context.imageSmoothingEnabled=!1,context.setTransform(previewWindow.scale,0,0,previewWindow.scale,previewWindow.offsetX,previewWindow.offsetY),context.drawImage(vCanvas,0,0)}function zoom(e){const t=canvas.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,i=e.deltaY<=0?1.1:1/1.1,a=(n-previewWindow.offsetX)/previewWindow.scale,c=(o-previewWindow.offsetY)/previewWindow.scale;previewWindow.scale*=i,previewWindow.offsetX=n-a*previewWindow.scale,previewWindow.offsetY=o-c*previewWindow.scale,draw()}function press(e,t){const n=canvas.getBoundingClientRect();previewWindow.isDragging=!0,previewWindow.isTouchZooming=!1,canvas.classList.add("grabbing"),previewWindow.lastX=e-n.left,previewWindow.lastY=t-n.top}function move(e,t){if(!previewWindow.isDragging||previewWindow.isTouchZooming)return;const n=canvas.getBoundingClientRect(),o=e-n.left-previewWindow.lastX,i=t-n.top-previewWindow.lastY;previewWindow.offsetX+=o,previewWindow.offsetY+=i,previewWindow.lastX=e-n.left,previewWindow.lastY=t-n.top,draw()}function end(){previewWindow.isDragging=!1,canvas.classList.remove("grabbing")}function getTouchesDist(e,t){const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.hypot(n,o)}function getTouchesX(e,t){return(e.clientX+t.clientX)/2}function getTouchesY(e,t){return(e.clientY+t.clientY)/2}function mobileStartZoom(e,t){previewWindow.isDragging=!1,previewWindow.isTouchZooming=!0,previewWindow.lastTouchesDist=getTouchesDist(e,t)}function mobileZoom(e,t){const n=canvas.getBoundingClientRect(),o=getTouchesX(e,t)-n.left,i=getTouchesY(e,t)-n.top,a=getTouchesDist(e,t)-previewWindow.lastTouchesDist<=0?1/1.05:1.05,c=(o-previewWindow.offsetX)/previewWindow.scale,d=(i-previewWindow.offsetY)/previewWindow.scale;previewWindow.scale*=a,previewWindow.offsetX=o-c*previewWindow.scale,previewWindow.offsetY=i-d*previewWindow.scale,previewWindow.lastTouchesDist=getTouchesDist(e,t),draw()}function mobileEnd(){previewWindow.isDragging=!1,previewWindow.isTouchZooming=!1}function clampedArrayRGBtoRGBA(e,t,n){var o=new Uint8ClampedArray(t*n*4);for(let t=0,n=0;t<e.length;t+=3,n+=4)o[n]=e[t],o[n+1]=e[t+1],o[n+2]=e[t+2],o[n+3]=255;return o}function clampedArrayRGBA(e,t,n,o){return 3==o?clampedArrayRGBtoRGBA(e,t,n):4==o?new Uint8ClampedArray(e):void 0}function bytesToImageFormat(e){return 137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]?0:255===e[0]&&216===e[1]?1:82===e[0]&&73===e[1]&&70===e[2]&&70===e[3]&&87===e[8]&&69===e[9]&&66===e[10]&&80===e[11]?2:102===e[4]&&116===e[5]&&121===e[6]&&112===e[7]&&104===e[8]&&101===e[9]&&105===e[10]&&99===e[11]||102===e[4]&&116===e[5]&&121===e[6]&&112===e[7]&&104===e[20]&&101===e[21]&&105===e[22]&&99===e[23]?3:-1}function formatEnumToString(e){return 0==e?"png":1==e?"jpeg":2==e?"webp":3==e?"heic":void 0}function formatStringToEnum(e){return"png"==e?0:"jpeg"==e?1:"webp"==e?2:"heic"==e?3:void 0}vContext.imageSmoothingEnabled=!1;var filename="",input_format=0,conversionConfig={format:0,quality:90,width:250,height:250};function resetConfig(){config_format.value=formatEnumToString(input_format),config_quality.value=0==input_format?100:90,config_quality_visual.textContent=config_quality.value,config_width.value=decodedImage.width,config_height.value=decodedImage.height,download_div.innerHTML="",download_div.classList.add("hidden")}function applyConfig(){conversionConfig.format=formatStringToEnum(config_format.value),conversionConfig.quality=parseInt(config_quality.value,10),conversionConfig.width=parseInt(config_width.value,10),conversionConfig.height=parseInt(config_height.value,10),download_div.innerHTML="",download_div.classList.add("hidden")}var decodedImage={pixels:0,width:0,height:0,ratio:0,channels:0};function ConvertCall(e,t){if(download_div.classList.add("hidden"),0==t.channels)return;const n=t.pixels.length,o=Module._malloc(n);Module.HEAPU8.set(t.pixels,o);const i=Module._malloc(4),a=Module._malloc(4);if(encodeOK=Module._Encode(o,i,a,t.width,t.height,t.channels,e.format,e.quality,e.width,e.height),0==encodeOK)return outputElement.value+="Encode successfully failed",Module._free(o),Module._free(i),void Module._free(a);Module._free(o);const c=Module.getValue(i,"*"),d=Module.getValue(a,"i32");if(Module._free(i),Module._free(a),0!=d&&NaN!=d){const n=new Uint8Array(Module.HEAPU8.slice(c,c+d));n.set(Module.HEAPU8.subarray(c,c+d)),download_div.innerHTML="";const o=new Blob([n],{type:"image/"+formatEnumToString(e.format)}),i=URL.createObjectURL(o),a=document.createElement("a");a.href=i,a.download=filename+"-"+t.width.toString()+"x"+t.height.toString()+"."+formatEnumToString(e.format),a.textContent="Download result",download_div.appendChild(a),download_div.classList.remove("hidden")}Module._freeEncodeMalloc(c,e.format)}_input.addEventListener("change",(function(e){const t=e.target.files[0];if(!t)return;filename=t.name.replace(/\.(png|jpeg|jpg|webp|heic)$/i,"");const n=new FileReader;n.onload=function(){config_container.classList.add("hidden"),download_div.classList.add("hidden");const e=n.result,t=new Uint8Array(e),o=Module._malloc(t.length);Module.HEAPU8.set(t,o),input_format=bytesToImageFormat(t);const i=t.length,a=Module._malloc(4),c=Module._malloc(4),d=Module._malloc(4),l=Module._malloc(4);clearOutput(outputElement);const s=Module._Decode(o,i,input_format,a,c,d,l);if(resizeOutput(outputElement),0==s){outputElement.value+="Decode successfully failed";const e=Module.getValue(a,"*");return Module._freeDecodeMalloc(e,input_format),Module._free(a),Module._free(l),Module._free(d),Module._free(c),void Module._free(o)}const r=Module.getValue(a,"*"),u=Module.getValue(c,"i32"),g=Module.getValue(d,"i32"),f=Module.getValue(l,"i32");Module._free(a),Module._free(l),Module._free(d),Module._free(c),Module._free(o),config_format.value=formatEnumToString(input_format),config_quality.value=0==input_format?100:90,config_quality_visual.textContent=config_quality.value,config_width.value=u,config_height.value=g,conversionConfig.format=input_format,conversionConfig.quality=0==input_format?100:90,conversionConfig.width=u,conversionConfig.height=g,decodedImage.pixels=new Uint8Array(u*g*f),decodedImage.pixels.set(Module.HEAPU8.subarray(r,r+u*g*f)),decodedImage.width=u,decodedImage.height=g,decodedImage.ratio=u/g,decodedImage.channels=f,Module._freeDecodeMalloc(r,input_format),resetPreviewWindow(),canvas.classList.remove("grabbing");const v=clampedArrayRGBA(decodedImage.pixels,u,g,f),m=new ImageData(v,u,g);canvas.width=u>=600?600:u,canvas.height=g>=600?600:g,vCanvas.width=u,vCanvas.height=g,vContext.putImageData(m,0,0),draw(),config_container.classList.remove("hidden")},n.readAsArrayBuffer(t)})),canvas.addEventListener("wheel",(e=>{e.preventDefault(),zoom(e)})),canvas.addEventListener("mousedown",(e=>{press(e.clientX,e.clientY)})),canvas.addEventListener("mousemove",(e=>{e.preventDefault(),move(e.clientX,e.clientY)})),canvas.addEventListener("mouseup",(()=>{end()})),canvas.addEventListener("mouseleave",(()=>{end()})),canvas.addEventListener("touchstart",(function(e){e.preventDefault(),1==e.touches.length?press(e.touches[0].clientX,e.touches[0].clientY):2==e.touches.length&&mobileStartZoom(e.touches[0],e.touches[1])}),{passive:!1}),canvas.addEventListener("touchmove",(function(e){e.preventDefault(),1==e.touches.length?move(e.touches[0].clientX,e.touches[0].clientY):2==e.touches.length&&mobileZoom(e.touches[0],e.touches[1])}),{passive:!1}),canvas.addEventListener("touchend",(()=>{mobileEnd()}),{passive:!1}),canvas.addEventListener("touchcancel",(()=>{mobileEnd()}),{passive:!1}),_c_image_view.addEventListener("click",(function(){preview_container.classList.toggle("hidden"),main.classList.toggle("blurred")})),_c_image_hide.addEventListener("click",(function(){preview_container.classList.toggle("hidden"),main.classList.toggle("blurred")})),_c_config_view.addEventListener("click",(function(){config_popup.classList.toggle("hidden"),main.classList.toggle("blurred")})),_c_config_reset.addEventListener("click",(function(){resetConfig()})),_c_config_hide.addEventListener("click",(function(){config_popup.classList.toggle("hidden"),main.classList.toggle("blurred"),applyConfig()})),config_quality.addEventListener("input",(()=>{config_quality_visual.textContent=config_quality.value})),config_width_auto.addEventListener("click",(()=>{config_width.value=Math.floor(parseFloat(config_height.value)*decodedImage.ratio)})),config_height_auto.addEventListener("click",(()=>{config_height.value=Math.floor(parseFloat(config_width.value)/decodedImage.ratio)})),_c_convert_encode.addEventListener("click",(function(){ConvertCall(conversionConfig,decodedImage)}));